#!/usr/bin/perl

###########################################################################
# Copyright (C) 2014  John 'Warthog9' Hawley                              #
#                         jhawley@redhat.com                              #
#                         warthog9@eaglescrag.net                         #
#                                                                         #
# This file is originally part of SyncDiff(erent).                        #
#                                                                         #
# This library is free software; you can redistribute it and/or           #
# modify it under the terms of the GNU Lesser General Public              #
# License as published by the Free Software Foundation; either            #
# version 2.1 of the License, or (at your option) any later version.      #
#                                                                         #
# This library is distributed in the hope that it will be useful,         #
# but WITHOUT ANY WARRANTY; without even the implied warranty of          #
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU       #
# Lesser General Public License for more details.                         #
#                                                                         #
# You should have received a copy of the GNU Lesser General Public        #
# License along with this library; if not, write to the:                  #
#    Free Software Foundation, Inc.                                       #
#    51 Franklin Street                                                   #
#    Fifth Floor                                                          #
#    Boston, MA  02110-1301                                               #
#    USA                                                                  #
#                                                                         #
# Or, see <http://www.gnu.org/licenses/>.                                 #
###########################################################################

# Standard includes:
use Getopt::Long;
Getopt::Long::Configure(
			qw(
				bundling
				no_getopt_compat
				posix_default 
				no_ignore_case
				gnu_compat
			));
use POSIX ":sys_wait_h";

# Local program includes
use FileSync::SyncDiff::Config;
use FileSync::SyncDiff::Scanner;
use FileSync::SyncDiff::DB;
use FileSync::SyncDiff::File;
use FileSync::SyncDiff::Server;
use FileSync::SyncDiff::Client;
use FileSync::SyncDiff::Log;

# Debugging includes
use Data::Dumper;

## End includes

# Setup things:
$main::VERSION = '0.01';

sub display_help {
	print STDOUT "Right now, there is no helping anyone.\n";
	print STDOUT "If you are running this you had better be John 'Warthog9' Hawley\n";
}

#
# Run something
#

# Setup the argument handling, can't do much
# till we've procssed all of that
my $config_file;
my $run_as_server;
my $get_version;
my $get_help;
my $run_only_scan;
GetOptions (
		"c|config=s"	=> \$config_file,      # string
		"s|server"	=> \$run_as_server,
		"scan"		=> \$run_only_scan,
		"v|version"	=> \$get_version,
		"h|?|help"	=> \$get_help,
	   );

if( $get_version ){
	print STDOUT "Version: ". $main::VERSION ."\n";
	exit(0);
}

if( $get_help ){
	display_help();
	exit(0);
}

#
# Load up the Configuration file
#

if( ! defined $config_file ){
	$config_file = "syncdiff.cfg";
}

my $config = FileSync::SyncDiff::Config->new();
$config->read_config( $config_file );

my $log = FileSync::SyncDiff::Log->new( config => $config );

$log->info('Config File: %s', $config_file);
$log->info('Run as Server? %s',$run_as_server);
$log->info('Get Version? %s', $get_version);

# End opening and parsing the config file
# 	$config now exists and can be passed around
# 	as needed

my $dbconnection = FileSync::SyncDiff::DB->new( config => $config, log => $log );

$dbconnection->file( "psync.sqlite" );

$dbconnection->connect_and_fork();

if( $run_only_scan ){
	FileSync::SyncDiff::Scanner->full_scan( $config, $dbconnection, $log );
	exit(0);
} # end if( $run_only_scan )

if( $run_as_server ){
	my $server = FileSync::SyncDiff::Server->new( config => $config->config, dbref => $dbconnection, log => $log );
	$server->run();
	exit(0);
}

foreach $group_name ( keys %{ $config->config->{groups} } ){
	$log->info("Main client loop - group: %s", $group_name);

	foreach $base ( @{ $config->config->{groups}->{$group_name}->{patterns} } ){

		my $client = FileSync::SyncDiff::Client->new( config_options => $config->get_group_config( $group_name ), group => $group_name, groupbase => $base, groupbase_path => $config->get_truepath( $base ), dbref => $dbconnection, log => $log );

		$client->fork_and_connect();
	} # end base foreach
} # end group_name foreach